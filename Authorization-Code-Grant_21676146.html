<!DOCTYPE html>
<html>
    <head>
        <title>Qeo Open Source Project Documentation : Authorization Code Grant</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="docindex.html">Qeo Open Source Project Documentation</a></span>
                            </li>
                                                    <li>
                                <span><a href="Qeo-Open-Source-Project-Documentation_21675984.html">Qeo Open Source Project Documentation</a></span>
                            </li>
                                                    <li>
                                <span><a href="Developer-Documents_21676035.html">Developer Documents</a></span>
                            </li>
                                                    <li>
                                <span><a href="REST-API_21676144.html">REST API</a></span>
                            </li>
                                                    <li>
                                <span><a href="Using-OAuth-2.0-to-Access-Qeo-Rest-API_21676145.html">Using OAuth 2.0 to Access Qeo Rest API</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Qeo Open Source Project Documentation : Authorization Code Grant
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
    
            Created by <span class='author'> lissensj</span> on May 21, 2014
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h4 id="AuthorizationCodeGrant-AboutAuthorizationCodeGrant">About Authorization Code Grant</h4><p>In the Authorization Code grant, the client first retrieves an Authorization Code from the OAuth Server. The client can exchange this code for an access token and a refresh token. The access token can be used to access the Rest API. The refresh token can be used to retrieve a new access token without any further user interaction.</p><h4 id="AuthorizationCodeGrant-High-LevelFlow">High-Level Flow</h4><p>Below is a high-level flowchart for the Authorization Code grant type:<span style="color: rgb(34,34,34);"> </span></p><p><span style="color: rgb(34,34,34);"><img class="confluence-embedded-image" src="attachments/21676145/21958615.png" data-image-src="attachments/21676145/21958615.png"></span></p><h4 id="AuthorizationCodeGrant-UsedTokens">Used Tokens</h4><p>Each of the different token types defined by OAuth 2.0 serves a distinct purpose in the protocol. Here is a short overview of all the tokens that are used in Oauth 2.0:</p><div><ul><li><p><span style="color: rgb(0,0,0);"><strong>An authorization code</strong> is a short-lived token representing the user's access grant, created by the authorization server and passed to the client application via the browser. The client application sends the authorization code to the authorization server to obtain an access token and, optionally, a refresh token.</span></p></li><li><p><span style="color: rgb(0,0,0);"><strong>The access token</strong> is used by the client to make authenticated requests on behalf of the end user. It has a longer lifetime than the authorization code, typically on the order of minutes or hours. When the access token expires, attempts to use it will fail, and a new access token must be obtained via a refresh token.</span></p></li><li><p><span style="color: rgb(0,0,0);"><strong>The refresh token</strong> may have an indefinite lifetime, persisting until explicitly revoked by the end-user. The client application can store the refresh token, using it to periodically obtain fresh access tokens, but should be careful to protect it against unauthorized access, since, like a password, it can be repeatedly used to gain access to the resource server.</span></p></li></ul></div><h4 id="AuthorizationCodeGrant-DetailedFlow">Detailed Flow</h4><p><span style="color: rgb(34,34,34);">All applications follow the same basic pattern when accessing the Qeo Rest API using OAuth 2.0. At a high level, using OAuth 2.0 to access the Qeo Rest API consists of these general steps, the numbers between brackets corresponding with the steps of the OAuth 2 process in the diagram above: </span></p><ol><li><span style="color: rgb(34,34,34);">Register the application (done once) (refer to <em>Step 1</em> below)<br /> </span></li><li><span style="color: rgb(34,34,34);">Obtain an authorization code from the OAuth 2 Authorization server:</span><ol><li><span style="color: rgb(34,34,34);">Token request to the server (1)</span></li><li><span style="color: rgb(34,34,34);">User login and consent (2)</span></li><li><span style="color: rgb(34,34,34);">Return of Authorization token by the server (3)<br /> </span></li></ol></li><li><span style="color: rgb(34,34,34);">Obtain an access token</span><span style="color: rgb(34,34,34);"> from the OAuth 2 Authorization server</span>:<br /><ol><li><span style="color: rgb(34,34,34);">Present authorization code to the server (4)</span></li><li><span style="color: rgb(34,34,34);">Receive access token and refresh token (5)<br /> </span></li></ol></li><li><span style="color: rgb(34,34,34);">Provide the access token to the Qeo Rest API (6)<br /> </span></li><li><span style="color: rgb(34,34,34);">Refresh the access token:</span><ol><li><span style="color: rgb(34,34,34);">Send refresh token to<span> OAuth 2 Authorization </span>server</span></li><li><span style="color: rgb(34,34,34);">Get new authorization token from the server</span></li></ol></li></ol><h4 id="AuthorizationCodeGrant-Step1:RegisteryourApplication">Step 1: Register your Application</h4><p>This needs to be done only once. All applications that want to access the Qeo Rest API must be registered first. Currently registering your application is done by email (<a href="mailto:partnersalliancesupport@technicolor.com" class="external-link" rel="nofollow">partnersalliancesupport@technicolor.com</a>). In addition of a contact person and email, you will have to provide us the following information about your application:</p><div class="table-wrap"><table class="confluenceTable"><tbody><tr><th class="confluenceTh">Value</th><th class="confluenceTh">Description</th></tr><tr><td class="confluenceTd"><strong>application_name</strong></td><td class="confluenceTd">A user friendly way of representing your application to the user.</td></tr><tr><td class="confluenceTd"><strong>redirect_URI <strong><sup>(1)</sup></strong></strong></td><td class="confluenceTd">After authenticating the Oauth 2.0 Security Server, the browser of the user will be redirected to a URL. This URL must match the redirect_uri received by the registration process. </td></tr></tbody></table></div><p><span>You will get your personal client_id and client_secret that you can use inside your application:</span></p><div class="table-wrap"><table class="confluenceTable"><tbody><tr><th class="confluenceTh">Value</th><th class="confluenceTh">Description</th></tr><tr><td class="confluenceTd"><strong>client_id</strong></td><td class="confluenceTd">A unique identifier for your application. This is considered as public information and must be provided in the URL when accessing the Oauth 2.0 Security Server.</td></tr><tr><td class="confluenceTd"><strong>client_secret</strong></td><td class="confluenceTd">A client secret to authenticate your application against the OAuth server.</td></tr></tbody></table></div>    <div class="aui-message hint shadowed information-macro">
                            <span class="aui-icon icon-hint">Icon</span>
                <div class="message-content">
                            <p><sup>(1)</sup> For web applications, the redirect url must be the entry point of the application on which the user will be redirected after authentication.  For other applications, it can be any uri that fit the application environment, like urn or custom uri scheme registered to start the application. <span style="background-color: transparent;font-size: 10.0pt;line-height: 13.0pt;">If the use case requires it, it is possible to have several uri registered for the application.</span></p>
                    </div>
    </div>
<h4 id="AuthorizationCodeGrant-Step2:ObtainanauthorizationcodefromtheOauth2AuthorizationServer">Step 2: Obtain an authorization code from the Oauth2 Authorization Server</h4><p><span>Before your application can access the Qeo Rest API, it must obtain an access token that grants access to that API. A single access token may grant varying degrees of access to multiple APIs. </span></p><p>To obtain an access token, the user needs to be redirected to the authorization endpoint of the Security Management Server. This URL will present the user with a default OpenID selection page. The exact URL of this endpoint can be discovered in the <a href="Qeo-Root-Resource_21676148.html">Qeo Root Resource</a> of the server, under &quot;oauth&quot; &gt; &quot;authorization&quot; &gt; &quot;href&quot;.</p><p><span>Your application must provide the following parameters:</span></p><div class="table-wrap"><table class="confluenceTable"><tbody><tr><th class="highlight-grey confluenceTh" data-highlight-colour="grey">Parameter</th><th class="confluenceTh">Value</th><th class="confluenceTh">Description</th></tr><tr><td class="confluenceTd"><strong>response_type</strong></td><td class="confluenceTd">code</td><td class="confluenceTd">Indicates that the response will be an authorization code.</td></tr><tr><td class="confluenceTd"><strong>client_id</strong></td><td class="confluenceTd">The client ID obtained from the previous step</td><td class="confluenceTd"><span style="color: rgb(34,34,34);">Indicates the client that is making the request. The value passed in this parameter must exactly match the client ID received in step 1.</span></td></tr><tr><td class="confluenceTd"><strong>redirect_uri</strong></td><td class="confluenceTd">The redirect URI obtained from the previous step</td><td class="confluenceTd"><span style="color: rgb(34,34,34);">Determines where the response is sent. The value of this parameter must exactly match the redirect uri from step 1 (including the http or https schemes, case, and trailing '/').</span></td></tr></tbody></table></div><p>In addition to the mandatory OAuth parameters, the authorization request can contain the OpenID selection parameter. If provided, the default OpenID selection page won't be displayed. Instead the user will directly be redirected to the selected OpenId provider.</p><div class="table-wrap"><table class="confluenceTable"><tbody><tr><th class="confluenceTh">Paremeter</th><th class="confluenceTh">Value</th><th colspan="1" class="confluenceTh">Description</th></tr><tr><td colspan="1" class="confluenceTd"><strong>opIdentifier</strong></td><td colspan="1" class="confluenceTd">The discovery URL of the OpenID identifier.</td><td colspan="1" class="confluenceTd">This can be any OpenID 2.0 compliant provider.</td></tr></tbody></table></div><p><span style="color: rgb(0,0,0);">The user will be redirected to a login page requesting the credentials of the user. <span style="color: rgb(0,0,0);">Once the user has filled in his credentials, his browser will be redirected to the redirect_uri. The url where it is redirected to also gets a query string in its url containing a</span>n authorization code.</span></p><h4 id="AuthorizationCodeGrant-Step3:ObtainanaccesstokenfromtheOauth2AuthorizationServer">Step 3: Obtain an access token from the Oauth2 Authorization Server</h4><p><span>We can now do a request to exchange the authorization code for a access token. This is done if the application makes a POST request to the token endpoint. The exact URL of this endpoint can be discovered in the <a href="Qeo-Root-Resource_21676148.html">Qeo Root Resource</a> of the server, under &quot;oauth&quot; &gt; &quot;token&quot; &gt; &quot;href&quot;.<br /></span></p><p><span>Your application must provide the following parameters:</span></p><div class="table-wrap"><table class="confluenceTable"><tbody><tr><th class="highlight-grey confluenceTh" data-highlight-colour="grey">Parameter</th><th class="confluenceTh">Value</th><th class="confluenceTh">Description</th></tr><tr><td class="confluenceTd"><strong>grant_type</strong></td><td class="confluenceTd">authorization_code</td><td class="confluenceTd">Indicates the grant type that is used. This needs to be set to convert the authorization code into an access token.</td></tr><tr><td class="confluenceTd"><strong>code</strong></td><td class="confluenceTd">The code that was included in the redirect Url</td><td class="confluenceTd"><span style="color: rgb(34,34,34);">The authorization code returned from the initial request in step 2.</span></td></tr><tr><td colspan="1" class="confluenceTd"><strong>client_id</strong></td><td colspan="1" class="confluenceTd">The client ID</td><td colspan="1" class="confluenceTd">See step 1.</td></tr><tr><td colspan="1" class="confluenceTd"><strong>client_secret</strong></td><td colspan="1" class="confluenceTd">The client secret</td><td colspan="1" class="confluenceTd">See step 1.</td></tr><tr><td colspan="1" class="confluenceTd"><strong>redirect_uri</strong></td><td colspan="1" class="confluenceTd">The redirect URI</td><td colspan="1" class="confluenceTd">See step 1.</td></tr></tbody></table></div><p>The result of this POST request will contain a JSON string containing the following Fields:</p><div class="table-wrap"><table class="confluenceTable"><tbody><tr><th class="highlight-grey confluenceTh" data-highlight-colour="grey">Field</th><th class="confluenceTh">Description</th></tr><tr><td class="confluenceTd"><strong>access_token</strong></td><td class="confluenceTd"><span style="color: rgb(34,34,34);">The token that can be sent to the Qeo Rest API</span></td></tr><tr><td class="confluenceTd"><strong>expires_in</strong></td><td class="confluenceTd"><span style="color: rgb(34,34,34);">The remaining lifetime on the access token. This is set on 3600 seconds by default.</span></td></tr><tr><td class="confluenceTd"><strong>refresh_token</strong></td><td class="confluenceTd"><span style="color: rgb(34,34,34);">A token that may be used to obtain a new access token.</span></td></tr></tbody></table></div><p>You now have a valid access token and a refresh token.</p><h4 id="AuthorizationCodeGrant-Step4:ProvidetheAccessTokentotheQeoRestAPI">Step 4: Provide the Access Token to the Qeo Rest API</h4><p><span>After your application has obtained an access token, it can access the Qeo Rest API by including it in an </span><code>Authorization: Bearer</code><span> HTTP </span><span>header.</span></p><h4 id="AuthorizationCodeGrant-Step5:RefreshtheAccessToken">Step 5: Refresh the Access Token</h4><p><span>Access tokens have a limited lifetime and, in some cases, an application needs access to our Rest API beyond the lifetime of a single access token. When this is the case, your application can obtain what is called a refresh token. A refresh token allows your application to obtain new access tokens. Currently, tokens expire in 1 hour.</span></p><p>To request a new access token you will again have to send a POST request to the access token endpoint but this time with the following parameters:</p><div class="table-wrap"><table class="confluenceTable"><tbody><tr><th class="highlight-grey confluenceTh" data-highlight-colour="grey">Parameter</th><th class="confluenceTh">Value</th><th class="confluenceTh">Description</th></tr><tr><td class="confluenceTd"><strong>grant_type</strong></td><td class="confluenceTd">refresh_token</td><td class="confluenceTd">Indicates that the token endpoint needs to convert a refresh token to a new access token.</td></tr><tr><td class="confluenceTd"><strong>refresh_token</strong></td><td class="confluenceTd">the current refresh token</td><td class="confluenceTd"><span style="color: rgb(34,34,34);">The refresh token returned from the initial request in step 2. </span></td></tr><tr><td class="confluenceTd"><strong>client_id</strong></td><td class="confluenceTd">the client ID</td><td class="confluenceTd">The client ID obtained from step 1.</td></tr><tr><td colspan="1" class="confluenceTd"><strong>client_secret</strong></td><td colspan="1" class="confluenceTd">the client secret</td><td colspan="1" class="confluenceTd">The client secret obtained in step 1.</td></tr><tr><td colspan="1" class="confluenceTd"><strong>redirect_uri</strong></td><td colspan="1" class="confluenceTd">the redirect URI</td><td colspan="1" class="confluenceTd">The redirect URI obtained in step 1.</td></tr></tbody></table></div><p><span style="color: rgb(34,34,34);">You will then again receive a access_token, refresh_token and expires_in parameter.</span><span style="color: rgb(34,34,34);"> </span></p><h4 id="AuthorizationCodeGrant-Example">Example</h4><p><span style="color: rgb(34,34,34);">A company named <strong>Example.org</strong> wants to create their own web application for managing their Qeo Realms.</span></p><ol><li><p><span style="color: rgb(34,34,34);">They must first send an email to <a href="mailto:partnersalliancesupport@technicolor.com" class="external-link" rel="nofollow">partnersalliancesupport@technicolor.com</a> with the following information:<br /><br /></span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="theme: Default; brush: cpp; gutter: false" style="font-size:12px;">application_name: Example Qeo Web
redirect_URI:  http://qeo.example.org</pre>
</div></div><p><span style="color: rgb(34,34,34);"><br /><span>This means that the Security Server will only redirect to URLs starting with </span><em><span><span><a href="http://qeo.example.org" class="external-link" rel="nofollow">http://qeo.example.org</a></span></span></em><span>. For example </span><em><span><span><a href="http://qeo.example.org/index.php" class="external-link" rel="nofollow">http://qeo.example.org/index.php</a></span></span></em><span> will do, but </span><em><span><span><a href="http://www.example.org/" class="external-link" rel="nofollow">http://www.example.org/</a></span></span></em><span> will not.<br /></span><br /></span></p></li><li><p>After the application is approved they receive a mail from Technicolor, containing:<br /><br /></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="theme: Default; brush: cpp; gutter: false" style="font-size:12px;">client_id: 2Xc6zKMNu2R3nuK6DQfho6be2F4U6M3m
client_secret: Nq397Y7n563r9ugp5m2O9LP3s01U8Dx8</pre>
</div></div></li><li><p>Now they can start building their web application. The first step is to add a link to the authorization endpoint providing the necessary client_id and redirect_uri:<br /><br /></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="theme: Default; brush: cpp; gutter: false" style="font-size:12px;">&lt;a href=&quot;https://my.qeo.org/qeo-rest-security/oauth/authorize?response_type=code&amp;client_id=2Xc6zKMNu2R3nuK6DQfho6be2F4U6M3m&amp;redirect_uri=http://qeo.example.org&quot;&gt;Click here to login!&lt;/a&gt;</pre>
</div></div></li><li><p>When the user clicks this link the browser is redirected to a Google login page asking the user to login with his Google credentials. This information is NEVER given to the web application, which is the main advantage of using OpenID/OAuth2.0 for authentication. If it is the first time that the user is logged in this application he is asked whether he wants to trust this application. If the user clicks <strong>Accept</strong> he is redirected to:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="theme: Default; brush: cpp; gutter: false" style="font-size:12px;">http://qeo.example.org/?code=b02ca9907f0c15c60a18379f5385ee3672ff0f5d%7C1370942397177</pre>
</div></div><p>On subsequent logins, this check is skipped  since the application already has the trust information, and the user is redirected.<br /><br /></p><p>The web application located at <em><a href="http://qeo.example.org" class="external-link" rel="nofollow">http://qeo.example.org</a></em> will be able to fetch the GET parameters from the request and extract the authorization code. As described above, this will not be enough to start doing calls to the Qeo Rest API. We first need to exchange the authorization code to an access_token. This is done by doing a POST request to the /token endpoint:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="theme: Default; brush: cpp; gutter: false" style="font-size:12px;">POST /oauth/token HTTP/1.1
Host: my.qeo.org
Content-Type: application/x-www-form-urlencoded
grant_type=authorization_code&amp;code=b02ca9907f0c15c60a18379f5385ee3672ff0f5d%7C1370942397177&amp;client_id=2Xc6zKMNu2R3nuK6DQfho6be2F4U6M3m&amp;client_secret=Nq397Y7n563r9ugp5m2O9LP3s01U8Dx8&amp;redirect_uri=http://qeo.example.org</pre>
</div></div></li><li><p>This results in the following JSON response:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="theme: Default; brush: cpp; gutter: false" style="font-size:12px;">{
   &quot;access_token&quot;:&quot;2YotnFZFEjr1zCsicMWpAA&quot;,
   &quot;expires_in&quot;:3600,
   &quot;refresh_token&quot;:&quot;tGzv3JOkF0XG5Qx2TlKWIA&quot;,
}</pre>
</div></div></li><li><p>Now the<em> qeo.example.or</em>g application finally has an access_token that can be used for accessing the Qeo Rest API. For example if the application wants to display all Realms belonging to the user it will send a GET request containing the access_token in its header:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="theme: Default; brush: cpp; gutter: false" style="font-size:12px;">GET /v1/realms HTTP/1.1
Authorization: Bearer 2YotnFZFEjr1zCsicMWpAA
Host: my.qeo.org</pre>
</div></div></li><li><p><span>Note that the access_token that was provided in the JSON response is only valid for 3600 seconds. If the <em>qeo.example.org</em> application has a user which wants new information after that period, the application needs to do a POST request to the /token endpoint and provide the refresh_token to request a new access_token:<br /></span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="theme: Default; brush: cpp; gutter: false" style="font-size:12px;">POST /oauth/token HTTP/1.1
Host: my.qeo.org
Content-Type: application/x-www-form-urlencoded  
grant_type=refresh_token&amp;refresh_token=tGzv3JOkF0XG5Qx2TlKWIA&amp;client_id=2Xc6zKMNu2R3nuK6DQfho6be2F4U6M3m&amp;client_secret=Nq397Y7n563r9ugp5m2O9LP3s01U8Dx8&amp;redirect_uri=http://qeo.example.org</pre>
</div></div></li><li><p><span>It again results in a JSON response containing a new access_token:<br /></span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="theme: Default; brush: cpp; gutter: false" style="font-size:12px;">{
   &quot;access_token&quot;:&quot;2YotnFZFEjr1zCsicMWpAA&quot;,
   &quot;expires_in&quot;:3600,
   &quot;refresh_token&quot;:&quot;tGzv3JOkF0XG5Qx2TlKWIA&quot;,
}</pre>
</div></div></li></ol>
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/21676146/21958617.jpg">Oauth_authorization.jpg</a> (image/jpeg)
                                <br/>
                                                    </div>
                    </div>
                    
                 
                </div>             </div> 
            <div id="footer">
                <section class="footer-body">
                    <p>Document generated by Confluence on May 26, 2014 09:36</p>
                </section>
            </div>
        </div>     </body>
</html>
